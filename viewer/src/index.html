<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="static/lib/tailwind.css" />
    <script src="static/lib/generated.js"></script>
    <script src="static/script/utils.js"></script>
    <script src="static/lib/marked@12.0.1.min.js"></script>
    <script async src="static/script/load-mathjax.js"></script>
    <script defer src="static/lib/alpinejs@3.13.8.min.js"></script>
  </head>
  <body>
    <script>
      document.addEventListener("alpine:init", async () => {
        const posts = getPosts();
        Alpine.store("data", {
          users: getUsers(),
          posts: posts,
          currentPost: posts[0],
          setCurrent(post) {
            this.currentPost = post;
          },
        });
      });
    </script>
    <div id="grid-view-sidebar-and-current-post" class="grid grid-cols-4">
      <!-- posts sidebar feed -->
      <div
        id="grid-column-sidebar"
        class="col-span-1 h-[100vh] overflow-y-auto bg-gray-800"
        x-data="{ posts: $store.data.posts }"
      >
        <template x-data x-for="post in posts" :key="post.id">
          <div
            class="select-none space-y-1 border-t border-gray-600 bg-gray-700 p-4 text-gray-200 hover:bg-gray-600"
            x-data="{ mostRecentEdit: post.history[0] }"
            x-on:click="$store.data.setCurrent(post)"
          >
            <div class="pointer-events-none flex justify-between">
              <span
                class="text-sm font-bold"
                x-html="marked.parse(mostRecentEdit.subject)"
              ></span>
              <span
                class="text-sm"
                x-text="formatDate(mostRecentEdit.created)"
              ></span>
            </div>
            <div class="pointer-events-none h-12 overflow-hidden">
              <span
                class="text-xs"
                x-html="marked.parse(mostRecentEdit.content)"
              ></span>
            </div>
          </div>
        </template>
      </div>

      <!-- main post and followups -->
      <div
        id="grid-column-current-post"
        class="col-span-3 h-[100vh] space-y-4 overflow-y-auto bg-gray-900"
      >
        <!-- button for triggering latex typeset -->
        <div
          id="container-btn-typeset-latex"
          class="px-4 pt-4"
          x-data="{ show: JSON.parse(JSON.stringify($store.data.currentPost)) }"
          x-show="show"
          x-effect="show = JSON.stringify($store.data.currentPost).includes('$$');"
        >
          <button
            id="btn-typeset-latex"
            class="w-full rounded-md bg-green-400 px-2 py-1 text-sm text-green-900 hover:bg-green-500"
            x-on:click="show = false; MathJax.typeset();"
          >
            Click here to show LaTeX
          </button>
        </div>

        <!-- main post -->
        <div
          id="main-post"
          class="mx-4 mt-4 space-y-8 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-data="{ idx: 0 }"
        >
          <div
            id="main-post-header"
            class="flex justify-between text-xl font-bold"
          >
            <span
              id="main-post-title"
              x-html="
                marked.parse($store.data.currentPost.history[idx].subject)
              "
            ></span>
            <div id="main-post-type" class="flex space-x-4">
              <span
                class="rounded-md bg-gray-700 px-3 py-1 text-sm"
                x-text="$store.data.currentPost.type"
              ></span>
              <span
                id="main-post-viewcount"
                class="rounded-md bg-gray-700 px-2 py-1 text-sm"
                x-text="$store.data.currentPost.unique_views + ' views'"
              ></span>
            </div>
          </div>

          <div id="main-post-body" class="overflow-x-auto">
            <span
              id="main-post-content"
              class="space-y-2 text-sm"
              x-html="marked.parse($store.data.currentPost.history[idx].content)"
            ></span>
          </div>

          <div
            id="main-post-footer"
            class="flex justify-between align-text-bottom text-xs"
          >
            <span
              id="main-post-likes"
              class="text-blue-300"
              x-text="'good ' + $store.data.currentPost.type + ' | ' +
                $store.data.currentPost.tag_good.length"
            ></span>
            <div id="main-post-tags" class="space-x-2">
              <template x-for="tag in $store.data.currentPost.tags">
                <span
                  class="rounded-md bg-blue-400 px-2 py-1 text-blue-900"
                  x-text="tag"
                ></span>
              </template>
            </div>
          </div>
        </div>

        <!-- collective student answer -->
        <div
          id="students-collective-answer"
          class="mx-4 space-y-4 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-show="Boolean(getStudentsAnswer($store.data.currentPost))"
          x-data
        >
          <h1
            id="students-collective-answer-header"
            class="text-xl font-bold underline decoration-yellow-500 decoration-solid"
          >
            the students&apos; answer
          </h1>
          <div
            id="students-collective-answer-body"
            class="space-y-1 overflow-x-auto"
          >
            <div class="flex gap-x-2 text-sm">
              <span
                id="students-collective-answer-last-author"
                class="font-bold"
                x-text="getStudentsAnswerAuthor(
                  $store.data.currentPost, $store.data.users
                )"
              ></span>
              <span
                id="students-collective-answer-content"
                x-text="getStudentsAnswerDate($store.data.currentPost)"
              ></span>
            </div>
            <span
              id="students-collective-answer-date"
              class="text-sm"
              x-html="marked.parse(
                getStudentsAnswerContent($store.data.currentPost)
              )"
            />
          </div>
        </div>

        <!-- collective instructor answer -->
        <div
          id="instructors-collective-answer"
          class="mx-4 space-y-4 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-show="Boolean(getInstructorsAnswer($store.data.currentPost))"
          x-data
        >
          <h1
            id="instructors-collective-answer-header"
            class="text-xl font-bold underline decoration-yellow-500 decoration-solid"
          >
            the instructors&apos; answer
          </h1>
          <div
            id="instructors-collective-answer-body"
            class="space-y-1 overflow-x-auto"
          >
            <div class="flex gap-x-2 text-sm">
              <span
                id="instructors-collective-answer-last-author"
                class="font-bold"
                x-text="getInstructorsAnswerAuthor(
                  $store.data.currentPost, $store.data.users
                )"
              ></span>
              <span
                id="instructors-collective-answer-date"
                x-text="getInstructorsAnswerDate($store.data.currentPost)"
              ></span>
            </div>
            <span
              id="instructors-collective-answer-content"
              class="text-wrap text-sm"
              x-html="marked.parse(
                getInstructorsAnswerContent($store.data.currentPost)
              )"
            ></span>
          </div>
        </div>

        <!-- discussions -->
        <div
          id="followup-discussions"
          class="mx-4 space-y-4 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-show="getReplies($store.data.currentPost.children).length > 0"
          x-data
        >
          <h1
            id="followup-discussions-header"
            class="text-xl font-bold underline decoration-blue-500 decoration-solid"
          >
            followup discussions
          </h1>

          <!-- followup discussions -->
          <template
            x-for="followup in getReplies($store.data.currentPost.children)"
            :key="followup.id"
          >
            <div
              class="rounded-md bg-gray-700 px-6 py-4"
              x-data="{ fuid: '', fIsAnon: false }"
              x-init="
                fuid = followup.uid ?? followup.uid_a;
                fIsAnon = Boolean(followup.uid_a)
              "
            >
              <div class="flex flex-row gap-x-2 align-top">
                <img
                  class="mt-1 h-10 w-10 border border-gray-500"
                  :src="
                    fIsAnon ? (
                      getAnonIcon(fuid, $store.data.currentPost.id)
                    ) : getUserIcon(fuid, $store.data.users)
                  "
                />
                <div class="space-y-1 overflow-x-auto">
                  <div class="flex gap-x-2 text-sm">
                    <span
                      class="font-bold"
                      x-text="
                        fIsAnon ? (
                          getAnonName(fuid, currentPost.id)
                        ) : $store.data.users.get(fuid)?.name
                      "
                    ></span>
                    <span x-text="formatDate(followup.created)"></span>
                  </div>
                  <span
                    class="text-sm"
                    x-html="marked.parse(followup.subject)"
                  ></span>
                  <div class="pt-2 text-xs text-blue-300">
                    <span
                      x-text="
                        `helpful! | ${(followup?.tag_good?.length ?? 0)}`
                      "
                    ></span>
                  </div>
                </div>
              </div>

              <!-- nested replies to followup discussion -->
              <template
                x-for="child in getReplies(followup?.children)"
                :key="child.id"
              >
                <div
                  class="ml-2 mt-4 rounded-md bg-gray-800 px-6 py-4"
                  x-data="{ uid: '', isAnon: false }"
                  x-init="
                    uid = child.uid ?? child.uid_a;
                    isAnon = Boolean(child.uid_a)
                  "
                >
                  <div class="flex flex-row gap-x-2 align-top">
                    <img
                      class="mt-1 h-10 w-10 border border-gray-500"
                      :src="
                        isAnon ? (
                          getAnonIcon(uid, $store.data.currentPost.id)
                         ) : getUserIcon(uid, $store.data.users)
                      "
                    />
                    <div class="space-y-1 overflow-x-auto">
                      <div class="flex gap-x-2 text-sm">
                        <span
                          class="font-bold"
                          x-text="
                            isAnon ? (
                              getAnonName(child.uid_a, $store.data.currentPost.id)
                            ) : $store.data.users.get(uid)?.name
                          "
                        ></span>
                        <span x-text="formatDate(child.created)"></span>
                      </div>
                      <span
                        class="text-sm"
                        x-html="marked.parse(child.subject)"
                      ></span>
                      <div class="pt-2 text-xs text-blue-300">
                        <span
                          x-text="`helpful! | ${child?.tag_good?.length ?? 0}`"
                        ></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
  </body>
</html>
