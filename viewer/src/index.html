<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/assets/tailwind.css" />
    <script defer src="/assets/alpinejs-3.13.8.min.js"></script>
    <script src="/assets/marked-12.0.1.min.js"></script>
    <script>
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const day = (date.getDay() + 1).toString().padStart(2, "0");
        const year = date.getFullYear().toString().substr(-2);
        return `${month}/${day}/${year}`;
      };
      const getPosts = async () => {
        return (await (await fetch("/posts.json")).json()).posts;
      };
      const getReplies = (children) => {
        return (children ?? []).filter(
          (c) => c.type === "followup" || c.type === "feedback",
        );
      };
      const getInstructorAnswer = (children) => {
        const answer = (children ?? []).filter((c) => c.type === "i_answer");
        return answer.length > 0 ? answer[0].history[0] : {};
      };
      const getStudentAnswer = (children) => {
        const answer = (children ?? []).filter((c) => c.type === "s_answer");
        return answer.length > 0 ? answer[0].history[0] : {};
      };
    </script>
  </head>
  <body>
    <div
      class="grid grid-cols-4"
      x-data="{ posts: [], currentPost: { history: [{ subject: '', content: '' }], created: '' } }"
      x-init="posts = await getPosts(); currentPost = posts[0]"
    >
      <!-- posts list -->
      <div class="col-span-1 h-[100vh] overflow-y-scroll bg-gray-800">
        <template x-for="post in posts" :key="post.id">
          <div
            class="select-none space-y-1 border-x border-t border-gray-600 bg-gray-700 p-4 text-gray-200 hover:bg-gray-600"
            x-on:click="currentPost = post"
            x-data="{ h0: post.history[0] }"
          >
            <div class="pointer-events-none flex justify-between">
              <span
                class="text-sm font-bold"
                x-html="marked.parse(h0.subject)"
              ></span>
              <span class="text-sm" x-text="formatDate(h0.created)"></span>
            </div>
            <div class="pointer-events-none h-12 overflow-hidden">
              <span class="text-xs" x-html="marked.parse(h0.content)"></span>
            </div>
          </div>
        </template>
      </div>

      <!-- post view -->
      <div class="col-span-3 h-[100vh] space-y-4 overflow-y-scroll bg-gray-900">
        <!-- main post -->
        <div
          class="mx-4 mt-4 space-y-8 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
        >
          <div class="flex justify-between text-xl font-bold">
            <span x-html="marked.parse(currentPost.history[0].subject)"></span>
            <div class="flex space-x-4">
              <div
                class="rounded-md bg-gray-700 px-3 py-1 text-sm"
                x-text="currentPost.type"
                x-show="currentPost?.type"
              ></div>
              <div
                class="rounded-md bg-gray-700 px-2 py-1 text-sm"
                x-text="`${currentPost.unique_views} views`"
                x-show="currentPost?.unique_views > 0"
              ></div>
            </div>
          </div>
          <div class="overflow-x-scroll">
            <span
              class="space-y-2 text-sm"
              x-html="marked.parse(currentPost.history[0].content)"
            ></span>
          </div>

          <!-- like count and tags -->
          <div class="flex justify-between align-text-bottom text-xs">
            <div class="text-blue-300">
              <span
                x-text="`good note | ${(currentPost?.tag_good ?? []).length}`"
              ></span>
            </div>
            <div class="space-x-2">
              <template x-for="tag in (currentPost?.tags ?? [])">
                <span
                  class="rounded-md bg-blue-400 px-2 py-1 text-blue-900"
                  x-text="tag"
                ></span>
              </template>
            </div>
          </div>
        </div>

        <!-- student answer -->
        <div
          class="mx-4 space-y-4 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-show="getStudentAnswer(currentPost?.children).content"
        >
          <h1
            class="text-xl font-bold underline decoration-green-500 decoration-solid"
          >
            the students&apos; answer
          </h1>
          <div class="space-y-1">
            <div class="flex gap-x-2 text-sm">
              <span
                class="font-bold"
                x-text="getStudentAnswer(currentPost?.children).uid ?? getStudentAnswer(currentPost?.children).uid_a"
              ></span>
              <span
                x-text="formatDate(getStudentAnswer(currentPost?.children).created)"
              ></span>
            </div>
            <div class="overflow-x-scroll">
              <span
                class="text-sm"
                x-html="marked.parse(getStudentAnswer(currentPost?.children).content ?? '')"
              ></span>
            </div>
          </div>
        </div>

        <!-- instructor answer -->
        <div
          class="mx-4 space-y-4 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-show="getInstructorAnswer(currentPost?.children).content"
        >
          <h1
            class="text-xl font-bold underline decoration-yellow-500 decoration-solid"
          >
            the instructors&apos; answer
          </h1>
          <div class="space-y-1">
            <div class="flex gap-x-2 text-sm">
              <span
                class="font-bold"
                x-text="getInstructorAnswer(currentPost?.children).uid ?? getInstructorAnswer(currentPost?.children).uid_a"
              ></span>
              <span
                x-text="formatDate(getInstructorAnswer(currentPost?.children).created)"
              ></span>
            </div>
            <div class="overflow-x-scroll">
              <span
                class="text-sm"
                x-html="marked.parse(getInstructorAnswer(currentPost?.children).content ?? '')"
              ></span>
            </div>
          </div>
        </div>

        <!-- followup discussions -->
        <div
          class="mx-4 space-y-4 rounded-lg border border-gray-700 bg-gray-800 p-8 text-white"
          x-show="getReplies(currentPost?.children).length > 0"
        >
          <h1
            class="text-xl font-bold underline decoration-blue-500 decoration-solid"
          >
            followup discussions
          </h1>

          <!-- discussions -->
          <template
            x-for="followup in getReplies(currentPost?.children)"
            :key="followup.id"
          >
            <div class="rounded-md bg-gray-700 px-6 py-4">
              <div class="space-y-1">
                <div class="flex gap-x-2 text-sm">
                  <span
                    class="font-bold"
                    x-text="followup.uid ?? followup.uid_a"
                  ></span>
                  <span x-text="formatDate(followup.created)"></span>
                </div>
                <div class="overflow-x-scroll">
                  <span
                    class="text-sm"
                    x-html="marked.parse(followup.subject)"
                  ></span>
                </div>
                <div class="pt-2 text-xs text-blue-300">
                  <span
                    x-text="`helpful! | ${(followup?.tag_good ?? []).length}`"
                  ></span>
                </div>
              </div>

              <!-- replies to discussions -->
              <template
                x-for="child in getReplies(followup?.children)"
                :key="child.id"
              >
                <div class="ml-2 mt-4 rounded-md bg-gray-800 px-6 py-4">
                  <div class="space-y-1">
                    <div class="flex gap-x-2 text-sm">
                      <span
                        class="font-bold"
                        x-text="child.uid ?? child.uid_a"
                      ></span>
                      <span x-text="formatDate(child.created)"></span>
                    </div>
                    <div class="overflow-x-scroll">
                      <span
                        class="text-sm"
                        x-html="marked.parse(child.subject)"
                      ></span>
                    </div>
                    <div class="pt-2 text-xs">
                      <span
                        x-text="`helpful! | ${(child?.tag_good ?? []).length}`"
                      ></span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
  </body>
</html>
